version: 2
jobs:
  build:
    docker:
      - image: ubuntu:latest
    resource_class: 2xlarge+
    steps:
      - run:
          name: Install dependencies
          command: |
            apt update
            apt-get install -y python3 python3-venv git cmake ninja-build g++ python3-dev llvm
      - checkout # Important to run checkout step after git has been
                 # installed, otherwise submodules will not be setup
                 # properly
      - run:
          name: Git Submodules
          command: |
            git submodule sync --recursive
            git submodule update --init --recursive
      - run:
          name: Setup Python Virtualenv
          command: |
            python3 -m venv env
      - run:
          name: Checkout PyTorch
          command: |
            cd ..
            git clone https://github.com/pytorch/pytorch.git --recursive
      - run:
          name: Build PyTorch
          command: |
            source env/bin/activate
            cd ../pytorch
            pip install -r requirements.txt
            BUILD_BINARY=OFF BUILD_TEST=0 BUILD_CAFFE2_OPS=0 python setup.py install
      - run:
          name: Build and test pytorch/tvm
          command: |
            source env/bin/activate

            python setup.py install --cmake
            mkdir -p tvm/build/

            OMP_NUM_THREADS=1 python setup.py test
